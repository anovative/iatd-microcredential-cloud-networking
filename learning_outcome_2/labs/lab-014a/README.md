## IATD Microcredential Cloud Networking: Lab 14a - Advanced BGP: Path Selection and Route Reflector Functionality

**Objective:** Examine advanced BGP route selection rules and route reflector concepts to optimize routing in complex network environments.

**Estimated Time:** 60 minutes

**Prerequisites:**

1. **Azure Subscription:** An active Azure subscription.
2. **Azure Cloud Shell:** Access to Azure Cloud Shell (PowerShell).
3. **Completion of Lab 13b:** You should have completed Lab 13b or have the configuration from Lab 13b readily available.
4. **Existing VNet, Route Server, and ExpressRoute:** Ensure you still have the existing Route Server and ExpressRoute peering setup from previous labs. This is an external resource that will not be created as part of this lab.
5. **On-Premises Router Access:** Administrative access to your on-premises router connected to ExpressRoute for reviewing BGP configurations.
6. **Familiarity with BGP Concepts:** Understanding of previous labs' content, ability to identify advertised routes and peered networks.

**Let's get started!**

### Lab Conventions

* **Azure Cloud Shell:** All PowerShell interactions will occur within the Azure Cloud Shell environment.
* **Naming Conventions:** Resource names follow the convention `iatd_labs_14a_*`.
* **IP Address Range:** The `172.16.x.x` range will be used for Azure resources.
* **Location:** Choose a consistent Azure region where your ExpressRoute circuit is deployed.

#### Resource Naming

* **Resource Group:** `iatd_labs_12a_rg` (reusing from previous labs)
* **Virtual Network:** `iatd_labs_12a_vnet` (reusing from previous labs)
* **Route Server:** `iatd_labs_12a_routeserver` (reusing from previous labs)
* **ExpressRoute Circuit:** Your existing ExpressRoute circuit

### Part 1: Prepare the Environment

1. **Open Cloud Shell:** Open Azure Cloud Shell and select **PowerShell**.

2. **Define Variables:**

   ```powershell
   # Reuse variables from previous labs
   $resourceGroupName = "iatd_labs_12a_rg"  # Use your existing resource group
   $location = "australiaeast"  # Use your existing region
   $vnetName = "iatd_labs_12a_vnet"  # Your existing VNet
   $routeServerName = "iatd_labs_12a_routeserver"  # Your existing Route Server
   $expressRouteCircuitName = "your-expressroute-circuit-name" # Replace with your circuit name
   $peeringType = "PrivatePeering"
   $onPremBgpAsn = "65000"  # Replace with your on-premises ASN
   ```

3. **Verify Resources:**

   ```powershell
   # Get Route Server details
   $routeServer = Get-AzRouteServer -Name $routeServerName -ResourceGroupName $resourceGroupName
   
   # Get ExpressRoute Circuit details
   $expressRouteCircuit = Get-AzExpressRouteCircuit -Name $expressRouteCircuitName -ResourceGroupName $resourceGroupName
   ```

   Expected Output (partial):
   ```
   Name                : iatd_labs_12a_routeserver
   ResourceGroupName   : iatd_labs_12a_rg
   Location            : australiaeast
   ProvisioningState   : Succeeded
   ```

### Part 2: Understanding BGP Route Selection Process

BGP uses a specific set of criteria to select the best path when multiple paths to the same destination exist. Understanding this process is crucial for optimizing routing in complex networks.

1. **BGP Path Selection Criteria (in Priority Order):**

   BGP evaluates the following attributes in order when selecting the best path:

   1. **Weight** - Higher weight is preferred (Cisco-specific attribute)
      * Local to the router
      * Not advertised to peers
      * Range: 0-65535, default is 0
      * Used to influence outbound traffic

   2. **Local Preference** - Higher local preference is preferred
      * Shared within the AS
      * Not advertised to external peers
      * Range: 0-4294967295, default is 100
      * Used to influence outbound traffic

   3. **Self-Originated Routes** - Prefer routes originated by the local router
      * Routes generated by the router itself (network statements, redistributed routes)

   4. **AS Path Length** - Shorter AS_PATH is preferred
      * Counts the number of AS hops to reach the destination
      * Fewer AS hops generally means a more direct path

   5. **Origin Code** - Preference order: IGP (i) > EGP (e) > Incomplete (?)
      * IGP: Routes originated within the AS
      * EGP: Routes learned via EGP (historical)
      * Incomplete: Routes with unknown origin

   6. **Multi-Exit Discriminator (MED)** - Lower MED value is preferred
      * Used to influence inbound traffic from neighboring ASes
      * Only compared for routes from the same AS

   7. **eBGP over iBGP** - Prefer eBGP-learned routes over iBGP-learned routes
      * eBGP routes are learned from external peers
      * iBGP routes are learned from internal peers

   8. **IGP Metric** - Prefer the path with the lowest IGP metric to the BGP next hop
      * Used as a tie-breaker when multiple iBGP paths exist

   9. **Router ID** - Prefer the path from the router with the lowest BGP Router ID
      * Used as a final tie-breaker

2. **Practical Implications:**

   Understanding these criteria allows network administrators to influence routing decisions by manipulating specific attributes. For example:

   * To influence outbound traffic, adjust Weight or Local Preference
   * To influence inbound traffic, adjust AS Path length (AS path prepending) or MED
   * For load balancing, ensure paths have equal attributes up to the desired level

### Part 3: Route Reflectors in BGP Deployments

Route reflectors solve the scalability challenge in iBGP networks by eliminating the need for a full mesh of iBGP peering sessions.

1. **Route Reflector Concept:**

   In a standard iBGP deployment, all iBGP speakers must be fully meshed, meaning every router must peer with every other router. This creates a scalability issue as the number of required peering sessions grows exponentially with the number of routers (n(n-1)/2 sessions for n routers).

   Route reflectors solve this problem by allowing a router (the route reflector) to advertise iBGP-learned routes to other iBGP peers, breaking the standard iBGP split-horizon rule.

2. **Benefits of Route Reflectors:**

   * **Scalability:** Dramatically reduces the number of required BGP sessions
   * **Simplified Configuration:** Easier to add new routers to the network
   * **Reduced Resource Requirements:** Less CPU and memory usage on edge routers
   * **Faster Convergence:** Fewer BGP sessions to establish and maintain

3. **Route Reflector Components:**

   * **Route Reflector:** The router configured to reflect routes
   * **Route Reflector Clients:** Routers that peer with the route reflector
   * **Non-Clients:** Other iBGP peers that are not clients of the route reflector
   * **Cluster:** A route reflector and its clients
   * **Cluster ID:** Identifier used to prevent routing loops

4. **Azure Route Server as a Route Reflector:**

   Azure Route Server acts as a route reflector in the Azure environment. It learns routes from all connected BGP peers (like your on-premises router via ExpressRoute) and reflects them to other peers, eliminating the need for you to establish BGP sessions between all your virtual network appliances.

### Part 4: Influencing Path Selection

1. **Using BGP Communities:**

   BGP communities are tags attached to routes that can be used to influence path selection. They are particularly useful for implementing routing policies across large networks.

   Example use cases:

   * **Traffic Engineering:** Direct traffic through preferred paths
   * **Regional Routing Policies:** Apply different policies based on geographic regions
   * **Service Level Differentiation:** Route traffic based on service requirements

2. **Using AS Path Prepending:**

   AS path prepending involves artificially lengthening the AS path by repeating your own AS number in the path. This makes the route less preferred by BGP's path selection process.

   Example (on your on-premises router):
   ```
   # For Cisco IOS (commands may vary based on your router OS)
   
   route-map PREPEND_AS_PATH permit 10
     set as-path prepend 65000 65000 65000
   
   router bgp 65000
     neighbor 172.16.0.1 route-map PREPEND_AS_PATH out
   ```

3. **Using Local Preference:**

   Local preference can be used to influence outbound traffic by preferring one exit point over another.

   Example (on your on-premises router):
   ```
   # For Cisco IOS (commands may vary based on your router OS)
   
   ip prefix-list PREFERRED_ROUTES seq 5 permit 192.168.1.0/24
   
   route-map SET_LOCAL_PREF permit 10
     match ip address prefix-list PREFERRED_ROUTES
     set local-preference 200
   
   route-map SET_LOCAL_PREF permit 20
   
   router bgp 65000
     neighbor 172.16.0.1 route-map SET_LOCAL_PREF in
   ```

### Part 5: Practical Verification

1. **Verify BGP Neighbors:**

   On your on-premises router, verify BGP neighbor relationships:

   ```
   # For Cisco IOS (commands may vary based on your router OS)
   show ip bgp summary
   ```

   Expected Output (example):
   ```
   BGP router identifier 10.0.0.1, local AS number 65000
   BGP table version is 12, main routing table version 12
   2 network entries using 288 bytes of memory
   2 path entries using 208 bytes of memory
   2/1 BGP path/bestpath attribute entries using 304 bytes of memory
   1 BGP AS-PATH entries using 24 bytes of memory
   0 BGP route-map cache entries using 0 bytes of memory
   0 BGP filter-list cache entries using 0 bytes of memory
   BGP using 824 total bytes of memory
   BGP activity 2/0 prefixes, 2/0 paths, scan interval 60 secs
   
   Neighbor        V    AS MsgRcvd MsgSent   TblVer  InQ OutQ Up/Down  State/PfxRcd
   172.16.0.1      4 12076    1234    1234       12    0    0 00:45:23        1
   ```

2. **Verify Routes Learned from Azure:**

   ```
   # For Cisco IOS (commands may vary based on your router OS)
   show ip bgp neighbors 172.16.0.1 routes
   ```

   Expected Output (example):
   ```
   BGP table version is 12, local router ID is 10.0.0.1
   Status codes: s suppressed, d damped, h history, * valid, > best, i - internal
   Origin codes: i - IGP, e - EGP, ? - incomplete
   
      Network          Next Hop            Metric LocPrf Weight Path
   *> 172.16.0.0/16    172.16.0.1               0             0 12076 i
   ```

3. **Verify Routes Advertised to Azure:**

   ```
   # For Cisco IOS (commands may vary based on your router OS)
   show ip bgp neighbors 172.16.0.1 advertised-routes
   ```

   Expected Output (example):
   ```
   BGP table version is 12, local router ID is 10.0.0.1
   Status codes: s suppressed, d damped, h history, * valid, > best, i - internal
   Origin codes: i - IGP, e - EGP, ? - incomplete
   
      Network          Next Hop            Metric LocPrf Weight Path
   *> 192.168.0.0/24   0.0.0.0                  0         32768 i
   ```

4. **Verify Route Selection in Azure:**

   ```powershell
   # Get the name of your BGP peering
   $peeringName = "your-bgp-peering-name" # Replace with your peering name
   
   # View routes learned from this peer
   Get-AzRouteServerPeerRoute -Name $peeringName -ResourceGroupName $resourceGroupName -RouteServerName $routeServerName
   ```

### Clean Up Resources

1. **Note on Resource Cleanup:**

   Since we are reusing resources from previous labs, we will not delete them here. If you are completely finished with all labs, you can delete the resources as follows:

   ```powershell
   # Remove the Route Server
   Remove-AzRouteServer -Name $routeServerName -ResourceGroupName $resourceGroupName -Force
   
   # Remove the virtual network
   Remove-AzVirtualNetwork -Name $vnetName -ResourceGroupName $resourceGroupName -Force
   
   # Clean up Azure resources
   # Note: This will NOT delete your ExpressRoute circuit if it's in a different resource group
   Remove-AzResourceGroup -Name $resourceGroupName -Force
   ```

   > **Important Note:** This cleanup process removes all Azure resources created for the labs. Your ExpressRoute circuit will not be affected if it's in a different resource group. Any configurations made on your on-premises router should be reviewed and removed if no longer needed.

### Post-Lab Summary

In this lab, you:
1. Learned about the BGP path selection process and its criteria
2. Understood the role and benefits of route reflectors in large-scale BGP deployments
3. Explored methods to influence path selection using BGP attributes
4. Verified BGP peering and route exchange between your on-premises network and Azure

These advanced BGP concepts are essential for designing and implementing robust hybrid connectivity solutions with Azure. Understanding path selection and route reflectors will help you optimize routing, improve network performance, and enhance reliability in complex network environments.
